# https://taskfile.dev

# execute using task -t Taskfile.gcloud_wip_setup.yml $TASK
version: '3'

dotenv: ['.env', '{{.HOME}}/.env']

env:
  PROJECT_ID: qaware-paal
  FULL_REPO_NAME: agentic-layer/cross-selling-use-case
  WORKLOAD_IDENTITY_POOL: github-actions-pool
  PROVIDER_NAME: github-actions-provider

tasks:

  set-gcloud-account-to-project-account:
    gcloud config set account {{.PROJECT_ID}}

  create-workload-identity-pool:
    desc: Create a GCP Workload Identity Pool for github actions
    requires:
      vars: [ PROJECT_ID, WORKLOAD_IDENTITY_POOL ]
    cmd: |
      gcloud iam workload-identity-pools create "{{.WORKLOAD_IDENTITY_POOL}}" \
        --project="{{.PROJECT_ID}}" \
        --location="global" \
        --display-name="{{.WORKLOAD_IDENTITY_POOL}}"

  create-workload-identity-provider:
    desc: Create a GCP Workload Identity Provider for github actions
    requires:
      vars: [PROJECT_ID, WORKLOAD_IDENTITY_POOL, PROVIDER_NAME]
    cmd: |
      gcloud iam workload-identity-pools providers create-oidc "{{.PROVIDER_NAME}}" \
        --project="{{.PROJECT_ID}}" \
        --location="global" \
        --workload-identity-pool="{{.WORKLOAD_IDENTITY_POOL}}" \
        --attribute-mapping="google.subject=assertion.sub,attribute.actor=assertion.actor,attribute.aud=assertion.aud,attribute.repository=assertion.repository" \        --issuer-uri="https://token.actions.githubusercontent.com" \
        --display-name="{{.PROVIDER_NAME}}" \
        --attribute-condition="assertion.repository == '{{.FULL_REPO_NAME}}' 

  auth-workload-provider:
    desc: Authenticate with the GCP Workload Identity Provider
    requires:
      vars: [PROJECT_ID, WORKLOAD_IDENTITY_POOL, PROVIDER_NAME]
    cmd: |
      gcloud iam service-accounts add-iam-policy-binding "github-actions@qaware-paal.iam.gserviceaccount.com" \
	  --project="{{.PROJECT_ID}}" \
	  --role="roles/iam.workloadIdentityUser" \
      --member="principalSet://iam.googleapis.com/projects/387309373030/locations/global/workloadIdentityPools/github-actions-pool/attribute.repository/agentic-layer/cross-selling-use-case"