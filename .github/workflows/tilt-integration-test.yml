name: Tilt Integration Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  # Required environment variables for the test
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

jobs:
  tilt-integration-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout cross-selling-use-case code
      uses: actions/checkout@v4
      with:
        path: cross-selling-use-case

    - name: Checkout infrastructure code
      uses: actions/checkout@v4
      with:
        repository: agentic-layer/infrastructure
        path: infrastructure
        ref: feat/local_k8s_setup # todo fix me before merge!
        ssh-key: ${{ secrets.INFRASTRUCTURE_REPO_DEPLOY_KEY }}

    - name: Install k3d
      run: |
        curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash
        k3d version

    - name: Install Tilt
      run: |
        curl -fsSL https://raw.githubusercontent.com/tilt-dev/tilt/master/scripts/install.sh | bash
        tilt version

    - name: Create k3d cluster
      run: |
        k3d cluster create local-paal \
          --registry-create local-paal-registry:5000 \
          --port "8080:80@loadbalancer" \
          --port "8443:443@loadbalancer" \
          --k3s-arg "--disable=traefik@server:0"

        # Wait for cluster to be ready
        kubectl wait --for=condition=Ready nodes --all --timeout=30s

    - name: Run Tilt CI
      run: |
        cd cross-selling-use-case
        # Use tilt ci which blocks until resources are healthy or fail
        tilt ci --context=k3d-local-paal

    - name: Port forward insurance host agent
      run: |
        kubectl port-forward -n use-case-cross-selling deployment/insurance-host-agent 8000:8000 &
        PORT_FORWARD_PID=$!
        echo "PORT_FORWARD_PID=$PORT_FORWARD_PID" >> $GITHUB_ENV

        # Wait for port forward to establish
        sleep 5

        # Test if port forward is working
        timeout 10 bash -c 'until curl -f http://localhost:8000/health 2>/dev/null; do echo "Waiting for port forward..."; sleep 2; done' || true

    - name: Test agent conversation
      run: |
        echo "Testing cross-selling conversation..."

        # OpenAI API is stateless - no session needed
        echo "Using OpenAI-compatible API endpoint"

        # Start conversation with cross-selling request
        echo "Sending cross-selling request..."
        CONVERSATION_RESPONSE=$(timeout 90 curl -s -X POST http://localhost:8000/api/v1/chat/completions \
          -H "Content-Type: application/json" \
          -H "Accept: application/json" \
          -d '{
            "model": "insurance_host_agent",
            "messages": [
              {
                "role": "user",
                "content": "Bitte entwickle eine cross-selling-strategie für Kunde cust001"
              }
            ]
          }' || echo '{"error": "timeout"}')

        echo "Conversation response:"
        echo "$CONVERSATION_RESPONSE" | jq '.' 2>/dev/null || echo "$CONVERSATION_RESPONSE"

        # Check if response contains expected content
        if echo "$CONVERSATION_RESPONSE" | grep -q "cust001\|cross.sell\|strategie\|kunde" -i; then
          echo "✅ SUCCESS: Agent responded with relevant cross-selling content"
        else
          echo "❌ FAILURE: Agent response doesn't contain expected content"
          exit 1
        fi

    - name: Show Tilt logs on failure
      if: failure()
      run: |
        echo "=== Tilt Session Status ==="
        tilt describe session --context=k3d-local-paal || true

        echo "=== Pod Status ==="
        kubectl get pods -n use-case-cross-selling || true

        echo "=== Insurance Host Agent Logs ==="
        kubectl logs -n use-case-cross-selling deployment/insurance-host-agent --tail=50 || true

        echo "=== Cross Selling Agent Logs ==="
        kubectl logs -n use-case-cross-selling deployment/cross-selling-agent --tail=50 || true

    - name: Cleanup
      if: always()
      run: |
        # Stop port forward
        if [ ! -z "$PORT_FORWARD_PID" ]; then
          kill $PORT_FORWARD_PID || true
        fi

        # Tilt ci automatically cleans up, but ensure it's down
        tilt down --context=k3d-local-paal || true

        # Delete k3d cluster
        k3d cluster delete local-paal || true
