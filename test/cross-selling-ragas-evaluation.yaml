apiVersion: testworkflows.testkube.io/v1
kind: TestWorkflow
metadata:
  name: cross-selling-ragas-evaluation
  namespace: testkube
  labels:
    test-type: ragas-evaluation
    component: insurance-agents
    agent: cross-selling
spec:
  # Pod configuration with shared volume
  pod:
    volumes:
      - name: shared-data
        emptyDir: {}

  # Container configuration shared across all template steps
  container:
    workingDir: /app
    image: "{{ config.image }}"
    env:
      - name: OPENAI_API_BASE
        value: "http://ai-gateway-litellm.ai-gateway:4000"
      - name: OPENAI_API_KEY
        value: "sk-placeholder"
    volumeMounts:
      - name: shared-data
        mountPath: /app/data

  # Global configuration that applies to all steps
  config:
    # Dataset configuration
    datasetUrl:
      type: string
      description: "URL to the dataset file"
      default: "http://data-server.data-server.svc.cluster.local:8000/cross-selling-dataset.csv"

    # Agent configuration
    agentUrl:
      type: string
      description: "URL to the agent endpoint"
      default: "http://cross-selling-agent.showcase-cross-selling.svc.cluster.local:8000"

    # Evaluation configuration
    model:
      type: string
      description: "Model for evaluation"
      default: "gemini-2.5-flash-lite"

    metrics:
      type: string
      description: "Metrics to evaluate (space-separated)"
      default: "faithfulness answer_relevancy context_precision"

    # Publishing configuration
    workflowName:
      type: string
      description: "Workflow name for metrics"
      default: "cross-selling-ragas-evaluation"


    otlpEndpoint:
      type: string
      description: "OTLP endpoint URL"
      default: "http://lgtm.monitoring:4318"

    # Docker image
    image:
      type: string
      description: "Docker image to use"
      default: "ghcr.io/agentic-layer/testbench/testworkflows:0.1.1"

  # Steps using the templates
  steps:
    # Step 1: Setup - Download and convert dataset
    - name: setup
      template:
        name: ragas-setup-template
        config:
          datasetUrl: "{{ config.datasetUrl }}"
          image: "{{ config.image }}"

    # Step 2: Run - Execute agent queries
    - name: run
      template:
        name: ragas-run-template
        config:
          agentUrl: "{{ config.agentUrl }}"
          image: "{{ config.image }}"

    # Step 3: Evaluate - Run RAGAS evaluation
    - name: evaluate
      template:
        name: ragas-evaluate-template
        config:
          model: "{{ config.model }}"
          metrics: "{{ config.metrics }}"
          image: "{{ config.image }}"

    # Step 4: Publish - Push metrics to OTLP
    - name: publish
      template:
        name: ragas-publish-template
        config:
          workflowName: "{{ config.workflowName }}"
          otlpEndpoint: "{{ config.otlpEndpoint }}"
          image: "{{ config.image }}"

    # Step 5: Summary - Display results
    - name: display-summary
      shell: |
        echo "=========================================="
        echo "Cross-Selling Agent RAGAS Evaluation Complete"
        echo "=========================================="
        echo ""
        echo "Agent tested: {{ config.agentUrl }}"
        echo "Model used for evaluation: {{ config.model }}"
        echo "Metrics evaluated: {{ config.metrics }}"
        echo ""
        if [ -f data/results/evaluation_scores.json ]; then
          echo "Final Scores:"
          cat data/results/evaluation_scores.json | jq '.'
          echo ""
          echo "✓ Metrics published to: {{ config.otlpEndpoint }}"
          echo "  View in Grafana: http://localhost:11000"
        else
          echo "⚠ Evaluation scores file not found"
          exit 1
        fi
        echo "=========================================="