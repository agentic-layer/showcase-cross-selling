# https://taskfile.dev
version: '3'

dotenv: ['.env', '{{.HOME}}/.env']

env:
  REPO_NAME: agentic-playground
  GITHUB_USER: qaware-internal
  GCP_PROJECT: qaware-paal
  GCP_REGION: europe-west3
  GCP_CLUSTER: k8s-{{.REPO_NAME}}

tasks:
  default:
    desc: If running only "task" print all available tasks
    cmd: task --list-all
    silent: true

  brew:
    desc: Install tool dependencies with brew
    internal: true
    run: once
    platforms: [darwin, linux]
    cmd: brew bundle --no-lock --verbose
    status:
      - brew bundle check --verbose

  gke-cluster-create:
    desc: Create a GKE cluster
    silent: true
    requires:
      vars: [REPO_NAME, GCP_REGION, GCP_PROJECT, GCP_CLUSTER]
    cmd: |
      gcloud container clusters create {{.GCP_CLUSTER}} \
        --project={{.GCP_PROJECT}} \
        --region={{.GCP_REGION}} \
        --addons HttpLoadBalancing,HorizontalPodAutoscaling,ConfigConnector \
        --workload-pool={{.GCP_PROJECT}}.svc.id.goog \
        --num-nodes=1 \
        --min-nodes=1 --max-nodes=3 \
        --enable-autoscaling \
        --autoscaling-profile=optimize-utilization \
        --enable-vertical-pod-autoscaling \
        --machine-type=e2-small \
        --enable-autorepair \
        --enable-autoupgrade \
        --release-channel=regular \
        --logging=SYSTEM \
        --monitoring=SYSTEM
      kubectl create clusterrolebinding cluster-admin-binding --clusterrole=cluster-admin --user=$(gcloud config get-value core/account)
      kubectl cluster-info

  flux-bootstrap:
    desc: Bootstrap Flux
    silent: true
    requires:
      vars: [GITHUB_USER, GITHUB_TOKEN, REPO_NAME]
    cmd: | 
      flux bootstrap github \
        --owner={{.GITHUB_USER}} \
        --repository={{.REPO_NAME}} \
        --branch=main \
        --path=./platform/foundation \
        --components-extra=image-reflector-controller,image-automation-controller \
        --read-write-key \
        --personal

  flux-sync:
    desc: Reconcile flux-system
    silent: true
    cmd: flux reconcile source git flux-system

  flux-status:
    desc: Show the status of the flux-system
    silent: true
    cmd: flux get all --all-namespaces

  secrets-create:
    desc: Create the OpenAI secret
    silent: true
    requires:
      vars: [OPENAI_API_KEY]
    cmd: kubectl create secret generic openai-api-key --from-literal=OPENAI_API_KEY={{.OPENAI_API_KEY}} --from-literal=OPENAI_APIKEY={{.OPENAI_API_KEY}}
