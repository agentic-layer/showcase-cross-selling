name: E2E Tests

on:
  push:
    branches:
      - main
      - 'renovate/**'
  pull_request:
  workflow_dispatch:

env:
  # Required environment variables for the test
  GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}

jobs:
  tilt-integration-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Create k8s Kind Cluster
        uses: helm/kind-action@v1

      - name: Install Tilt
        run: |
          curl -fsSL https://raw.githubusercontent.com/tilt-dev/tilt/master/scripts/install.sh | bash
          tilt version

      - name: Run Tilt CI
        run: tilt ci --timeout=30m

      - name: Verify Deployment
        run: |
          kubectl port-forward service/agent-gateway -n agent-gateway 11002:10000 &
          ./test/e2e/a2a-message.sh

      - name: Logs
        if: failure()
        run: |
          echo ""
          echo "Kubernetes Pod Statuses:"
          kubectl get pods --all-namespaces

          echo ""
          echo "Agent Gateway Logs:"
          kubectl logs -n agent-gateway -l app=agent-gateway || true

          echo ""
          echo "AI Gateway Logs:"
          kubectl logs -n ai-gateway -l app=ai-gateway || true

          echo ""
          echo "Agent Logs:"
          kubectl logs -n showcase-cross-selling -l app=insurance-host-agent || true
          kubectl logs -n showcase-cross-selling -l app=communications-agent || true
          kubectl logs -n showcase-cross-selling -l app=cross-selling-agent || true
