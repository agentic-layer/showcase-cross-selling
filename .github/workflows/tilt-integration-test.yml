name: Tilt Integration Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  # Required environment variables for the test
  GOOGLE_API_KEY: ${{ secrets.GEMINI_API_KEY }}

jobs:
  tilt-integration-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout cross-selling-use-case code
      uses: actions/checkout@v4

    - name: Kubernetes KinD Cluster
      id: kind
      uses: helm/kind-action@v1
      with:
        registry: true

    - name: Install Tilt
      run: |
        curl -fsSL https://raw.githubusercontent.com/tilt-dev/tilt/master/scripts/install.sh | bash
        tilt version

    - name: Run Tilt CI
      run: tilt ci -- --run-tests
