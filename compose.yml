services:
  # A2A Communications Agent
  communications-agent:
    build:
      context: .
      dockerfile: agents/Dockerfile
      args:
        AGENT_NAME: communications_agent
    ports:
      - "10002:8000"
    env_file: agents/.env
    environment:
      OTEL_EXPORTER_OTLP_ENDPOINT: http://tempo:4318
      OTEL_SERVICE_NAME: communications-agent
      GOOGLE_APPLICATION_CREDENTIALS: /tmp/keys/keyfile.json
    volumes:
      - $HOME/.config/gcloud/application_default_credentials.json:/tmp/keys/keyfile.json:ro

  # A2A Cross-Selling Agent
  cross-selling-agent:
    build:
      context: .
      dockerfile: agents/Dockerfile
      args:
        AGENT_NAME: cross_selling_agent
    ports:
      - "10003:8000"
    env_file: agents/.env
    environment:
      OTEL_EXPORTER_OTLP_ENDPOINT: http://tempo:4318
      OTEL_SERVICE_NAME: cross-selling-agent
      MCP_CUSTOMER_CRM_URL: http://mcp-customer-crm:8002/mcp
      MCP_INSURANCE_PRODUCTS_URL: http://mcp-insurance-products:8003/mcp
      GOOGLE_APPLICATION_CREDENTIALS: /tmp/keys/keyfile.json
    volumes:
      - $HOME/.config/gcloud/application_default_credentials.json:/tmp/keys/keyfile.json:ro
    depends_on:
      - mcp-customer-crm
      - mcp-insurance-products

  # MCP Server - Customer CRM
  mcp-customer-crm:
    build:
      context: .
      dockerfile: mcp-servers/Dockerfile
      args:
        MCP_SERVER_NAME: customer_crm
    ports:
      - "8002:8000"

  # MCP Server - Insurance Products
  mcp-insurance-products:
    build:
      context: .
      dockerfile: mcp-servers/Dockerfile
      args:
        MCP_SERVER_NAME: insurance_products
    ports:
      - "8003:8000"

  # A2A Insurance Host Agent
  insurance-host-agent:
    build:
      context: .
      dockerfile: agents/insurance_host_agent/Dockerfile
      args:
        AGENT_NAME: insurance_host_agent
    ports:
      - "10004:8000"
      - "8001:8001"
    env_file: agents/.env
    environment:
      OTEL_EXPORTER_OTLP_ENDPOINT: http://tempo:4318
      OTEL_SERVICE_NAME: insurance-host-agent
      GOOGLE_APPLICATION_CREDENTIALS: /tmp/keys/keyfile.json
    volumes:
      - $HOME/.config/gcloud/application_default_credentials.json:/tmp/keys/keyfile.json:ro
    depends_on:
      - communications-agent
      - cross-selling-agent

  # Grafana and Grafana Tempo
  tempo:
    image: grafana/tempo:latest
    command: [ "-config.file=/etc/tempo.yaml" ]
    volumes:
      - ./dev/tempo/tempo-config.yaml:/etc/tempo.yaml
    ports:
      - "3200:3200"      # Tempo UI
      - "4318:4318"      # OTLP HTTP receiver

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
    depends_on:
      - tempo
    volumes:
      - ./dev/grafana/datasource.yaml:/etc/grafana/provisioning/datasources/datasource.yaml
