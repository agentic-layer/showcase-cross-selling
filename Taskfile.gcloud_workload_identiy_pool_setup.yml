# https://taskfile.dev

# GCP Workload Identity Pool Setup for GitHub Actions
# ===================================================
# 
# This Taskfile automates the setup of Google Cloud Platform (GCP) Workload Identity Pool
# for GitHub Actions authentication. This enables GitHub Actions workflows to authenticate
# with GCP services without storing long-lived service account keys.
#
# Prerequisites:
# - gcloud CLI installed and authenticated
# - Appropriate GCP project permissions (IAM Admin, Service Account Admin)
# - GitHub repository configured with the correct repository name
#
# Usage:
#   task -t Taskfile.gcloud_workload_identiy_pool_setup.yml <task-name>
#
# Example workflow:
#   1. task -t Taskfile.gcloud_workload_identiy_pool_setup.yml create-workload-identity-pool
#   2. task -t Taskfile.gcloud_workload_identiy_pool_setup.yml create-workload-identity-provider
#   3. task -t Taskfile.gcloud_workload_identiy_pool_setup.yml auth-workload-provider
#
# Configuration:
# - Modify the env variables below to match your project settings
# - The FULL_REPO_NAME should match your GitHub repository (owner/repo-name)
# - The PROJECT_ID should match your GCP project ID
version: '3'

dotenv: ['.env', '{{.HOME}}/.env']

env:
  PROJECT_ID: qaware-paal
  FULL_REPO_NAME: agentic-layer/cross-selling-use-case
  WORKLOAD_IDENTITY_POOL: github-actions-pool
  PROVIDER_NAME: github-actions-provider

tasks:

  set-gcloud-account-to-project-account:
    desc: Set gcloud CLI to use the project service account
    cmd: gcloud config set account {{.PROJECT_ID}}

  create-workload-identity-pool:
    desc: Create a GCP Workload Identity Pool for github actions
    requires:
      vars: [ PROJECT_ID, WORKLOAD_IDENTITY_POOL ]
    cmd: |
      gcloud iam workload-identity-pools create "{{.WORKLOAD_IDENTITY_POOL}}" \
        --project="{{.PROJECT_ID}}" \
        --location="global" \
        --display-name="{{.WORKLOAD_IDENTITY_POOL}}"

  create-workload-identity-provider:
    desc: Create a GCP Workload Identity Provider for github actions
    requires:
      vars: [PROJECT_ID, WORKLOAD_IDENTITY_POOL, PROVIDER_NAME]
    cmd: |
      gcloud iam workload-identity-pools providers create-oidc "{{.PROVIDER_NAME}}" \
        --project="{{.PROJECT_ID}}" \
        --location="global" \
        --workload-identity-pool="{{.WORKLOAD_IDENTITY_POOL}}" \
        --attribute-mapping="google.subject=assertion.sub,attribute.actor=assertion.actor,attribute.aud=assertion.aud,attribute.repository=assertion.repository" \        --issuer-uri="https://token.actions.githubusercontent.com" \
        --display-name="{{.PROVIDER_NAME}}" \
        --attribute-condition="assertion.repository == '{{.FULL_REPO_NAME}}' 

  auth-workload-provider:
    desc: Authenticate with the GCP Workload Identity Provider
    requires:
      vars: [PROJECT_ID, WORKLOAD_IDENTITY_POOL, PROVIDER_NAME]
    cmd: |
      gcloud iam service-accounts add-iam-policy-binding "github-actions@qaware-paal.iam.gserviceaccount.com" \
	  --project="{{.PROJECT_ID}}" \
	  --role="roles/iam.workloadIdentityUser" \
      --member="principalSet://iam.googleapis.com/projects/387309373030/locations/global/workloadIdentityPools/github-actions-pool/attribute.repository/agentic-layer/cross-selling-use-case"